<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preload" as="video" href="/background.webm" type="video/webm">
  <title>PLinChina RSVP</title>

  <style>
    :root {
      --card-radius: 18px;
      --card-pad: 18px;
      --maxw: 520px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Arial;
      color: #111;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Background video */
    .bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      overflow: hidden;
      background: #000; /* fallback */
    }
    .bg video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* lekkie "uspokojenie" wideo */
      filter: saturate(0.95) contrast(0.95);
    }
    /* White haze overlay */
    .bg::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.62); /* "zamglenie" */
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    /* Main layout */
    .wrap {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 22px 16px 28px;
    }

    .card {
      width: min(var(--maxw), 100%);
      background: rgba(255,255,255,0.92);
      border-radius: var(--card-radius);
      padding: var(--card-pad);
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
      border: 1px solid rgba(0,0,0,0.06);
    }

    .logo {
      display: grid;
      place-items: center;
      margin: 6px 0 14px;
    }

    .logo img {
      max-width: 120px;
      width: 55%;
      height: auto;
      display: block;
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 22px;
      letter-spacing: 0.2px;
    }

    .hint {
      margin: 0 0 16px 0;
      color: #333;
      font-size: 14px;
      line-height: 1.35;
    }

    input {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      margin-bottom: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.16);
      background: rgba(255,255,255,0.95);
      outline: none;
    }
    input:focus {
      border-color: rgba(0,0,0,0.35);
      box-shadow: 0 0 0 4px rgba(0,0,0,0.06);
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
      background: #111;
      color: #fff;
    }
    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .message {
      margin-top: 14px;
      padding: 12px;
      border-radius: 12px;
      word-break: break-word;
      white-space: pre-wrap;
      text-align: left;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .success { background: #e6f7ea; }
    .error { background: #fdeaea; }

    .small {
      margin-top: 12px;
      font-size: 12.5px;
      color: #555;
    }

    .lang {
      margin-top: 14px;
      font-size: 12.5px;
      color: #555;
      user-select: none;
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .lang a {
      color: inherit;
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      background: rgba(255,255,255,0.7);
    }

    .lang a.active {
      border-color: rgba(0,0,0,0.55);
      font-weight: 600;
      background: rgba(255,255,255,0.95);
    }

    @media (max-width: 380px) {
      .logo img { width: 62%; }
      h1 { font-size: 20px; }
      button { font-size: 17px; }
    }
  </style>
</head>

<body>
  <!-- Background video -->
  <div class="bg" aria-hidden="true">
    <video autoplay muted loop playsinline preload="auto">
      <source src="background.webm" type="video/webm">
      <source src="background.mp4" type="video/mp4">
    </video>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="logo">
        <img src="logo.png" alt="Logo" />
        <hr>
      </div>
      <div class="lang" id="langSwitch">
        <span id="t_lang">Język:</span>
        <a href="#" data-lang="pl">PL</a>
        <a href="#" data-lang="en">EN</a>
        <a href="#" data-lang="zh">中文</a>
      </div>
      <br>
      <center><h1 id="t_title">Potwierdź swoją obecność</h1></center>
      <p id="t_hint" class="hint">Wpisz imię i nazwisko, aby aktywować przycisk.</p>

      <input id="firstName" placeholder="Imię" autocomplete="given-name" />
      <input id="lastName" placeholder="Nazwisko" autocomplete="family-name" />

      <button id="confirmBtn" disabled>Potwierdzam obecność</button>

      <div id="result"></div>
      <div id="t_note" class="small">Samo otwarcie linku nie potwierdza obecności.</div>

    </div>
  </div>

<script>
  const FUNCTION_URL = "https://dlapzkudardtyffzfksq.supabase.co/functions/v1/quick-handler";

  // --- i18n ---
  const i18n = {
    pl: {
      title: "Potwierdź chęć wzięcia udziału",
      hint: "<strong>Ważne!</strong> Każdy gość przed wejściem na wydarzenie musi okazać oryginalny, fizyczny dokument tożsamości. Uzupełnij ten formularz danymi, które znajdują się w dokumencie którym się posłużysz. <br><br><b>Akceptujemy tylko:</b><br> - Paszport, <br>- ID dyplomatyczne, <br>- ID (wydane przez władze Chińskiej Republiki Ludowej).<br><br><strong> Nie będą akceptowane: kopie, skany i zdjęcia w smartfonach.</strong>",
      first_ph: "Imię (dokładnie jak na ID)",
      last_ph: "Nazwisko (dokładnie jak na ID)",
      btn: "Potwierdzam chęć wzięcia udziału",
      saving: "Zapisywanie...",
      ok: "Potwierdzone ✅ Zapraszamy 29 kwietnia!",
      badlink: "Nieprawidłowy link.",
      neterr: "Błąd połączenia. Spróbuj ponownie.",
      fail: "Nie udało się zapisać odpowiedzi.",
      conflict: "Nieprawidłowy link lub już potwierdzono.",
      note: "Samo otwarcie linku nie potwierdza obecności.",
      lang: "Język:"
    },
    en: {
      title: "Confirm your attendance",
      hint: "<strong>Important!</strong> Every guest must present an original, physical ID document before entering the event. Complete this form with the data found on your ID.<br><br><b>We only accept:</b><br>- Passport,<br>- Diplomatic ID,<br>- ID (issued by the authorities of the People's Republic of China).<br><br><strong>Copies, scans, and photos on smartphones will not be accepted.</strong>",
      first_ph: "First Name (exactly as on ID)",
      last_ph: "Last Name (exactly as on ID)",
      btn: "I confirm my attendance",
      saving: "Saving...",
      ok: "Confirmed ✅ See you on April 29th!",
      badlink: "Invalid link.",
      neterr: "Connection error. Please try again.",
      fail: "Failed to save response.",
      conflict: "Invalid link or already confirmed.",
      note: "Opening the link does not confirm attendance. ",
      lang: "Language:"
    },
    zh: {
      title: "确认参加",
      hint: "<strong>重要提示！</strong> 每位宾客在进入活动前必须出示原始的实体身份证件。请根据您身份证件上的信息填写此表。<br><br><b>我们仅接受：</b><br>- 护照，<br>- 外交官证，<br>- 身份证（由中华人民共和国政府签发）。<br><br><strong>不接受复印件、扫描件及手机照片。</strong>",
      first_ph: "名字（须与证件一致）",
      last_ph: "姓氏（须与证件一致）",
      btn: "确认参加",
      saving: "正在保存...",
      ok: "确认成功 ✅ 4月29日见！",
      badlink: "链接无效。",
      neterr: "连接错误。请重试。",
      fail: "无法保存回复。",
      conflict: "链接无效或已确认。",
      note: "仅打开链接并不代表确认参加。",
      lang: "语言："
    }
  };

  function pickLang() {
    const params = new URLSearchParams(window.location.search);
    const urlLang = (params.get("lang") || "").toLowerCase();
    if (urlLang && i18n[urlLang]) return urlLang;

    const nav = (navigator.language || "en").toLowerCase();
    if (nav.startsWith("pl")) return "pl";
    if (nav.startsWith("zh")) return "zh";
    return "en";
  }

  let lang = pickLang();
  let dict = i18n[lang];

  function applyI18n() {
    dict = i18n[lang];

    document.getElementById("t_title").innerText = dict.title;
    document.getElementById("t_hint").innerHTML = dict.hint;
    document.getElementById("t_note").innerText = dict.note;
    document.getElementById("t_lang").innerText = dict.lang;

    document.getElementById("firstName").placeholder = dict.first_ph;
    document.getElementById("lastName").placeholder = dict.last_ph;
    document.getElementById("confirmBtn").innerText = dict.btn;

    document.querySelectorAll("#langSwitch a[data-lang]").forEach(a => {
      a.classList.toggle("active", a.dataset.lang === lang);
    });
  }

  function setLang(newLang) {
    if (!i18n[newLang]) return;
    lang = newLang;
    applyI18n();
    const u = new URL(window.location.href);
    u.searchParams.set("lang", lang);
    history.replaceState(null, "", u.toString());
  }

  document.querySelectorAll("#langSwitch a[data-lang]").forEach(a => {
    a.addEventListener("click", (e) => {
      e.preventDefault();
      setLang(a.dataset.lang);
    });
  });

  applyI18n();

  // --- RSVP logic ---
  const token = new URLSearchParams(window.location.search).get("t");

  const firstInput = document.getElementById("firstName");
  const lastInput = document.getElementById("lastName");
  const btn = document.getElementById("confirmBtn");
  const result = document.getElementById("result");

  function normalize(str) {
    return (str || "").trim().replace(/\s+/g, " ");
  }

  function validate() {
    const valid =
      token &&
      token.length >= 20 &&
      normalize(firstInput.value).length >= 1 &&
      normalize(lastInput.value).length >= 1;

    btn.disabled = !valid;
  }

  function showMessage(text, success = true) {
    result.className = "message " + (success ? "success" : "error");
    result.innerText = text;
  }

  if (!token) {
    showMessage(dict.badlink, false);
    btn.disabled = true;
  }

  firstInput.addEventListener("input", validate);
  lastInput.addEventListener("input", validate);
  validate();

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    showMessage(dict.saving, true);

    try {
      const response = await fetch(FUNCTION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token: token,
          first_name: normalize(firstInput.value),
          last_name: normalize(lastInput.value)
        })
      });

      const raw = await response.text();

      if (response.ok) {
        showMessage(dict.ok, true);
        // opcjonalnie: zablokuj inputy po sukcesie
        firstInput.disabled = true;
        lastInput.disabled = true;
        return;
      }

      let msg = dict.fail;
      try {
        const data = JSON.parse(raw);
        if (data && data.message) msg = data.message;
      } catch {}

      if (response.status === 409) msg = dict.conflict;

      showMessage(msg, false);
      validate();
    } catch (error) {
      showMessage(dict.neterr, false);
      validate();
    }
  });
</script>
</body>
</html>
