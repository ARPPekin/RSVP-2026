<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PLinChina RSVP</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Arial;
      max-width: 480px;
      margin: 60px auto;
      padding: 0 20px;
      text-align: center;
    }

    h1 { margin-bottom: 18px; }

    .hint {
      margin: 0 0 18px 0;
      color: #444;
      font-size: 14px;
      line-height: 1.35;
    }

    input {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 6px;
      word-break: break-word;
      white-space: pre-wrap;
      text-align: left;
    }

    .success { background: #e6f7ea; }
    .error { background: #fdeaea; }

    .small {
      margin-top: 12px;
      font-size: 13px;
      color: #666;
    }

    .lang {
      margin-top: 18px;
      font-size: 13px;
      color: #666;
      user-select: none;
    }

    .lang a {
      color: inherit;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin: 0 4px;
      display: inline-block;
    }

    .lang a.active {
      border-color: #999;
      font-weight: 600;
    }
  </style>
</head>
<body>

<div class="lang" id="langSwitch">
  <span id="t_lang">Język:</span>
  <a href="#" data-lang="pl">PL</a>
  <a href="#" data-lang="en">EN</a>
  <a href="#" data-lang="zh">中文</a>
</div>

<h1 id="t_title">Potwierdź swoją obecność</h1>
<p id="t_hint" class="hint">Wpisz imię i nazwisko, aby aktywować przycisk.</p>

<input id="firstName" placeholder="Imię" autocomplete="given-name" />
<input id="lastName" placeholder="Nazwisko" autocomplete="family-name" />

<button id="confirmBtn" disabled>Potwierdzam obecność</button>

<div id="result"></div>
<div id="t_note" class="small">Samo otwarcie linku nie potwierdza obecności.</div>



<script>
  const FUNCTION_URL = "https://dlapzkudardtyffzfksq.supabase.co/functions/v1/quick-handler";

  // --- i18n ---
  const i18n = {
    pl: {
      title: "Potwierdź chęć wzięcia udziału",
      hint: "Ważne! Każdy gość przed wejściem na przyjęcie musi okazać oryginalny, fizyczny dokument tożsamości. Uzupełnij ten formularz danymi, które znajdują się w Twoim ID. Akceptujemy tylko: Paszport, ID dyplomatyczne, ID (wydane przez władze Chińskiej Republiki Ludowej). Nie będą akceptowane: kopie, skany i zdjęcia w smartfonach.",
      first_ph: "Imię (dokładnie jak na ID)",
      last_ph: "Nazwisko (dokładnie jak na ID)",
      btn: "Potwierdzam chęć wzięcia udziału",
      saving: "Zapisywanie...",
      ok: "Potwierdzone ✅ Zapraszamy 29 kwietnia!",
      badlink: "Nieprawidłowy link.",
      neterr: "Błąd połączenia. Spróbuj ponownie.",
      fail: "Nie udało się zapisać odpowiedzi.",
      conflict: "Nieprawidłowy link lub już potwierdzono.",
      note: "Samo otwarcie linku nie potwierdza obecności.",
      lang: "Język:"
    },
    en: {
      title: "Confirm your attendance",
      hint: "Important! Every guest must present an original, physical ID document before entering the party. Complete this form with the data found on your ID. We only accept: Passport, Diplomatic ID, ID (issued by the authorities of the People's Republic of China).Copies, scans, and photos on smartphones will not be accepted.",
      first_ph: "First Name (exactly as on ID)",
      last_ph: "Last Name (exactly as on ID)",
      btn: "I confirm my attendance",
      saving: "Saving...",
      ok: "Confirmed ✅ See you on April 29th!",
      badlink: "Invalid link.",
      neterr: "Connection error. Please try again.",
      fail: "Failed to save response.",
      conflict: "Invalid link or already confirmed.",
      note: "Opening the link does not confirm attendance. ",
      lang: "Language:"
    },
    zh: {
      title: "确认参加",
      hint: "重要提示！每位宾客在进入派对前必须出示原始实体身份证件。请根据您身份证件上的信息填写此表。我们仅接受：护照、外交官证、身份证（由中华人民共和国政府签发）。不接受复印件、扫描件及手机照片。",
      first_ph: "名字（须与证件一致）",
      last_ph: "姓氏（须与证件一致）",
      btn: "确认参加",
      saving: "正在保存...",
      ok: "确认成功 ✅ 4月29日见！",
      badlink: "链接无效。",
      neterr: "连接错误。请重试。",
      fail: "无法保存回复。",
      conflict: "链接无效或已确认。",
      note: "仅打开链接并不代表确认参加。",
      lang: "语言："
    }
  };

  function pickLang() {
    const params = new URLSearchParams(window.location.search);
    const urlLang = (params.get("lang") || "").toLowerCase();
    if (urlLang && i18n[urlLang]) return urlLang;

    const nav = (navigator.language || "en").toLowerCase();
    if (nav.startsWith("pl")) return "pl";
    if (nav.startsWith("zh")) return "zh";
    return "en";
  }

  let lang = pickLang();
  let dict = i18n[lang];

  function applyI18n() {
    dict = i18n[lang];

    document.getElementById("t_title").innerText = dict.title;
    document.getElementById("t_hint").innerText = dict.hint;
    document.getElementById("t_note").innerText = dict.note;
    document.getElementById("t_lang").innerText = dict.lang;

    document.getElementById("firstName").placeholder = dict.first_ph;
    document.getElementById("lastName").placeholder = dict.last_ph;
    document.getElementById("confirmBtn").innerText = dict.btn;

    document.querySelectorAll("#langSwitch a[data-lang]").forEach(a => {
      a.classList.toggle("active", a.dataset.lang === lang);
    });
  }

  function setLang(newLang) {
    if (!i18n[newLang]) return;
    lang = newLang;
    applyI18n();

    // zachowaj token i dopisz lang do URL bez przeładowania
    const u = new URL(window.location.href);
    u.searchParams.set("lang", lang);
    history.replaceState(null, "", u.toString());
  }

  document.querySelectorAll("#langSwitch a[data-lang]").forEach(a => {
    a.addEventListener("click", (e) => {
      e.preventDefault();
      setLang(a.dataset.lang);
    });
  });

  applyI18n();

  // --- RSVP logic ---
  const token = new URLSearchParams(window.location.search).get("t");

  const firstInput = document.getElementById("firstName");
  const lastInput = document.getElementById("lastName");
  const btn = document.getElementById("confirmBtn");
  const result = document.getElementById("result");

  function normalize(str) {
    return (str || "").trim().replace(/\s+/g, " ");
  }

  function validate() {
    const valid =
      token &&
      token.length >= 20 &&
      normalize(firstInput.value).length >= 1 &&
      normalize(lastInput.value).length >= 1;

    btn.disabled = !valid;
  }

  function showMessage(text, success = true) {
    result.className = "message " + (success ? "success" : "error");
    result.innerText = text;
  }

  if (!token) {
    showMessage(dict.badlink, false);
    btn.disabled = true;
  }

  firstInput.addEventListener("input", validate);
  lastInput.addEventListener("input", validate);
  validate();

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    showMessage(dict.saving, true);

    try {
      const response = await fetch(FUNCTION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token: token,
          first_name: normalize(firstInput.value),
          last_name: normalize(lastInput.value)
        })
      });

      const raw = await response.text();

      if (response.ok) {
        showMessage(dict.ok, true);
        return;
      }

      // spróbuj wyciągnąć message z JSON
      let msg = dict.fail;
      try {
        const data = JSON.parse(raw);
        if (data && data.message) msg = data.message;
      } catch { /* ignore */ }

      // Jeśli 409 - pokaż ładny komunikat lokalny (a nie surowy)
      if (response.status === 409) msg = dict.conflict;

      showMessage(msg, false);
      validate();
    } catch (error) {
      showMessage(dict.neterr, false);
      validate();
    }
  });
</script>

</body>
</html>